## Codebase Patterns
- Keep `vitest.config.mts` `setupFiles` as an absolute path via `fileURLToPath(new URL(..., import.meta.url))` so tests resolve correctly in git worktrees.
- Build generation threat analysis from ranking names (`speciesIdToRankingName`) and simulation outcomes (`winsMatchup`) so API payloads remain adapter-thin while core logic stays in `lib/`.
- Derive downstream analysis sections from `analysis.threats.entries` in `lib/analysis/*` (instead of re-running matchup simulation) to keep API response assembly consistent and inexpensive.
- For shield-specific metrics, use `getShieldScenarioMatchupResult` and treat `null` as unevaluated data (not a hard loss) so analysis is stable when simulation coverage is partial.

## 2026-02-13 02:28:40 MST - US-001
Share Link: Unavailable in this environment (`/share` did not return a URL)
- Implemented top-level `analysis` payload in `POST /api/generate-team` while keeping `team` and `fitness` fields unchanged.
- Added a typed `GenerationAnalysis` contract and API test coverage validating backward compatibility plus independent analysis payload shape.
- Updated Vitest config to use an absolute setup file path so quality checks run in this worktree.
- Files changed: `app/api/generate-team/route.ts`, `app/api/generate-team/route.test.ts`, `lib/types.ts`, `vitest.config.mts`, `AGENTS.md`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - API routes should remain thin adapters and expose additive fields for backward-compatible response evolution.
    - Shared response contracts belong in `lib/types.ts` to keep route and UI typing consistent.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - In this worktree layout, relative Vitest `setupFiles` can resolve against the parent workspace root and break all tests.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Team generation response shape is consumed in `components/organisms/TeamManager/TeamManager.tsx` via `fetch('/api/generate-team')`.
---

## 2026-02-13 02:32:12 MST - US-002
Share Link: Unavailable in this environment (`/share` command is not executable here)
- Implemented top-50 threat analysis generation with per-threat team answer counts and rank-aware severity tiering.
- Wired threat analysis into `POST /api/generate-team` analysis payload as a dedicated `analysis.threats` structure.
- Added unit tests for exact top-50 evaluation, answer counting, rank-sensitive severity, and rank>100 severity de-escalation.
- Files changed: `lib/analysis/threatAnalysis.ts`, `lib/analysis/threatAnalysis.test.ts`, `app/api/generate-team/route.ts`, `app/api/generate-team/route.test.ts`, `lib/types.ts`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Keep analysis computation in `lib/analysis/*` and call it from app routes to preserve clean adapter boundaries.
    - Use ranked CSV ordering (`getTopPokemon('overall', N)`) as the canonical source of threat priority.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - When `GenerationAnalysis` is extended, update both API route tests and the shared contract in `lib/types.ts` to avoid drift.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Threat analysis currently ships in the API response under `analysis.threats` and is ready for upcoming UI stories.
---

## 2026-02-13 02:34:48 MST - US-003
Share Link: Unavailable in this environment (`/share` command is not executable here)
- Implemented core-breaker classification and ranking with team-size thresholds (3v3: answers <= 1, 6v6: answers <= 2) and severity rules for high-risk threats.
- Extended generation response analysis with `analysis.coreBreakers` derived from existing threat entries.
- Added focused unit tests for classification, severity, and rank ordering plus API route coverage for the new analysis field.
- Files changed: `lib/analysis/coreBreakerAnalysis.ts`, `lib/analysis/coreBreakerAnalysis.test.ts`, `lib/types.ts`, `app/api/generate-team/route.ts`, `app/api/generate-team/route.test.ts`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Compute additional analysis sections from `ThreatAnalysisEntry[]` to avoid duplicate simulation work and preserve a single threat-evaluation source of truth.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - When extending `GenerationAnalysis`, update API tests and mocked analysis builders in `app/api/generate-team/route.test.ts` together, or the route contract tests drift.
- Useful context (e.g., "the evaluation panel is in component X")
    - Core-breaker output now ships under `analysis.coreBreakers` with `threshold` and sorted entries for upcoming UI stories.
---

## 2026-02-13 02:38:17 MST - US-004
Share Link: Unavailable in this environment (`/share` command cannot run from this chat session)
- Implemented shield scenario analysis for `0-0`, `1-1`, and `2-2` with per-scenario coverage statistics and resilience to missing matchup rows.
- Added `analysis.shieldScenarios` to the generation API response contract and route assembly so UI can render scenario stats directly.
- Added tests for per-scenario aggregation behavior and missing-data handling, plus route contract coverage for the new analysis section.
- Files changed: `lib/analysis/shieldScenarioAnalysis.ts`, `lib/analysis/shieldScenarioAnalysis.test.ts`, `lib/data/simulations.ts`, `lib/types.ts`, `app/api/generate-team/route.ts`, `app/api/generate-team/route.test.ts`, `prd.json`, `progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Scenario-level analysis should reuse `analysis.threats.entries` and only query simulation ratings per shield scenario to keep new metrics additive and cheap.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - When adding new analysis sections, update both API route mocks and response assertions in `app/api/generate-team/route.test.ts` or tests can pass partial contracts accidentally.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Shield scenario stats are now available under `analysis.shieldScenarios` with keys `0-0`, `1-1`, and `2-2`.
---
